### Definitinon
Data granularity is the most important concept in SQL. Granularity is a measure of the level of detail in a table. In traditional relational databases (RDBMSs) the granularity is determined by the Primary Key of a table which ensures row uniqueness. 

By definition every table in a RDBMS must have a primary key, whether this means a natural key (for example a National ID like the SSN in United States), a subset of columns  or a surrogate key (like a Customer ID)

In cloud warehouses, the primary key isn't strictly enforced but the concept of granularity is of utmost importance. The reason is that if you join to a table with a 1-to-many relationship or the table contains duplicate rows (remember real world data is messy) you will duplicate the final result causing inaccuracies.

You need to know what your lowest level of granularity is at all times and make sure it remains unchanged in your final result set.

Let's look at an example:
```
select
	ph.id,
	ph.creation_date,
	ph.post_id,
	ph.user_id
from
	`bigquery-public-data.stackoverflow.post_history` ph
where
	ph.post_id = 69013214
	and ph.creation_date >= '2021-09-01'
	and ph.creation_date <= '2021-09-30'
order by ph.creation_date;
```

Table `post_history` has a granularity of one row per `id` for the same `post_id` as you can see below here
```
id       |creation_date          |post_id |user_id|
---------+-----------------------+--------+-------+
252984489|2021-09-01 07:50:59.920|69013214|9919951|
252984490|2021-09-01 07:50:59.920|69013214|9919951|
252984491|2021-09-01 07:50:59.920|69013214|9919951|
253020220|2021-09-01 20:16:56.193|69013214|9919951|
253020468|2021-09-01 20:28:29.213|69013214|9919951|
253045317|2021-09-02 06:33:36.687|69013214|       |
253045316|2021-09-02 06:33:36.687|69013214|8695460|
253045318|2021-09-02 06:33:36.687|69013214|9919951|
253060317|2021-09-02 10:29:56.990|69013214|9919951|
```

So if I were to join this table with the posts tables (e.g. `post_questions`) I'd get the same number of multiple rows for all the columns of the `post_questions` table I choose as demonstrated here:
```
select
	ph.id,
	q.id as post_id,
	q.title
from
	`bigquery-public-data.stackoverflow.post_history` ph
	inner join `bigquery-public-data.stackoverflow.posts_questions` q 
		on q.id = ph.post_id
where
	ph.post_id = 69013214
	and ph.creation_date >= '2021-09-01'
	and ph.creation_date <= '2021-09-30'
order by 
	ph.creation_date;
```

And the result:
```
id       |post_id |title                                                 |
---------+--------+------------------------------------------------------+
253045317|69013214|FontAwesome icon in Sass with Webpack is not displayed|
253045316|69013214|FontAwesome icon in Sass with Webpack is not displayed|
252984489|69013214|FontAwesome icon in Sass with Webpack is not displayed|
252984490|69013214|FontAwesome icon in Sass with Webpack is not displayed|
252984491|69013214|FontAwesome icon in Sass with Webpack is not displayed|
253060317|69013214|FontAwesome icon in Sass with Webpack is not displayed|
253020220|69013214|FontAwesome icon in Sass with Webpack is not displayed|
253020468|69013214|FontAwesome icon in Sass with Webpack is not displayed|
253045318|69013214|FontAwesome icon in Sass with Webpack is not displayed|
```

Whereas there's only one row per `post_id` in the`post_questions` table:
```
select
	q.id as post_id,
	q.title
from
	`bigquery-public-data.stackoverflow.posts_questions` q
where
	q.id = 69013214
	and q.creation_date >= '2021-09-01'
	and ph.creation_date <= '2021-09-30';
```

and the result:
```
post_id |title                                                 |
--------+------------------------------------------------------+
69013214|FontAwesome icon in Sass with Webpack is not displayed|
```

As you can see it's really important to know what the granularity of a table is, so how do you find it?

### Finding Granularity
Typically the Primary Key (PK) of a table is described in a schema document but if you don't have one handy, you can guess what it is and query the table directly to find out if you're right. Columns that have `id` in the name are great candidates to try first.

For example let's figure out what the granularity of the `post_history` table. Looking at the schema we see columns `id`, `revision_guid`, `post_id`, `user_id` Let's try `id` first then the others:
```
select 
	id,
	count(*) as cnt
from
	`bigquery-public-data.stackoverflow.post_history` ph
group by
	1
having 
	count(*) > 1;
```

We get an empty result set. This is exactly what we expect to get and that tells us this is the primary key column. 

Here's what happens if we try the `post_id`
```
select 
	post_id,
	count(*) as cnt
from
	`bigquery-public-data.stackoverflow.post_history` ph
group by
	1
having 
	count(*) > 1;
```

This is what we get back:
```
post_id |cnt|
--------+---+
69025133|  7|
69051498|  4|
68373269|  4|
68956431|  4|
68960908|  5|
68919355|  8|
15627170|  5|
69006073|  8|
69024187|  6|
68978720|  7|
```

This tells us there are multiple `post_id` for the same `id` so the granularity is `id` Later we'll discuss how to actually ensure the right granularity by using three different methods.